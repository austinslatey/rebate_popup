{% capture current_date %}{{ 'now' | date: '%s' }}{% endcapture %}
{% capture start_date %}{{ '2025-09-10' | date: '%s' }}{% endcapture %}
{% capture end_date %}{{ '2025-11-15' | date: '%s' | plus: 86399 }}{% endcapture %}

{% assign excluded_paths = '/account/login,/account/register,/collections/superwinch-rebate-2025' | split: ',' %}
{% assign is_excluded_page = false %}
{% for path in excluded_paths %}
  {% if request.path == path %}
    {% assign is_excluded_page = true %}
  {% endif %}
{% endfor %}
{% assign is_rebate_product = false %}
{% if product and product.collections contains collections['superwinch-rebate-2025'] %}
  {% assign is_rebate_product = true %}
{% endif %}

{% if current_date >= start_date and current_date <= end_date and is_excluded_page == false and is_rebate_product == false %}
  <div id="rebateModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img
        class="header-logo-image"
        src="https://cdn11.bigcommerce.com/s-c3z4vlowih/images/stencil/250x38/superwinch-logo-white_1724284008__21336.original.png"
        srcset="https://cdn11.bigcommerce.com/s-c3z4vlowih/images/stencil/250x38/superwinch-logo-white_1724284008__21336.original.png"
        alt="Superwinch"
        title="Superwinch"
      >
      <h2 id="color-change">Mail-In Consumer Rebate!</h2>
      <p class="secondary">
        From September 15 to November 15, 2025, get up to $100 cash back on select Superwinch items.
      </p>

      <!-- Carousel of qualifying items -->
      <h3 id="color-change">Qualifying Items:</h3>
      <div class="rebate-carousel">
        {% for product in collections['superwinch-rebate-2025'].products %}
          <div class="carousel-item">
            <a href="{{ product.url }}">
              <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title | escape }}">
              <p>{{ product.title }}</p>
            </a>
            {% if product.metafields.custom.cash_back_rebate_amount != blank %}
              <a
                href="{{ 'Superwinch-rebate-form.pdf' | file_url }}"
                target="_blank"
                class="cashback-notice"
                style="color: #2a2a2a; font-size: 14px; background-color: #e6f3ff; border-radius: 4px; padding: 8px 12px; margin: 10px 0; text-align: center; font-weight: 500; display: block; text-decoration: none;"
              >
                Cash Back: {{ product.metafields.custom.cash_back_rebate_amount | times: 100 | money }}
              </a>
            {% endif %}
          </div>
        {% else %}
          <p>No qualifying items available.</p>
        {% endfor %}
      </div>

      <button
        class="popupBtn"
        onclick="window.location.href='https://store.waldoch.com/collections/superwinch-rebate-2025'"
      >
        View All Qualifying Products
      </button>
      <!-- Rebate form options -->
      <div class="rebate-form-container">
        <h3 id="color-change">Get Your Rebate Form:</h3>
        <button class="popupBtn" onclick="window.open('{{ 'Superwinch-rebate-form.pdf' | file_url }}', '_blank')">
          View PDF
        </button>
        <div class="button-group">
          <form id="emailRebateForm" onsubmit="sendEmail(event)" class="rebate-form">
            <input type="email" id="userEmail" placeholder="Enter your email" required>
            <button type="submit" class="popupBtn">Email PDF to Me</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline CSS for modal and carousel -->
  <style>
    #rebateModal.modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
    }

    #rebateModal .header-logo-image {
      display: block;
      margin: 0 auto;
      max-height: 2.35714rem;
    }

    #rebateModal .secondary {
      color: rgb(255, 204, 102);
    }

    #rebateModal .popupBtn {
      background-color: rgb(255, 204, 102);
      font-size: 16px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #rebateModal .popupBtn:hover {
      background-color: rgb(230, 184, 92);
    }

    #rebateModal #color-change {
      margin-top: 8px;
      margin-bottom: 0;
      color: #fff;
    }

    #rebateModal .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgb(7, 64, 151);
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow: visible;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    #rebateModal .rebate-form-container {
      margin: 20px 0;
      text-align: center;
    }

    #rebateModal .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    #rebateModal .rebate-form {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 12px;
    }

    #rebateModal .rebate-form input {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #rebateModal .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    #rebateModal .close:hover {
      color: black;
    }

    #rebateModal .rebate-carousel {
      background-color: #fff;
      margin: 20px;
      position: relative;
    }

    #rebateModal .carousel-item {
      text-align: center;
      padding: 10px;
    }

    #rebateModal .carousel-item a {
      display: block;
      text-decoration: none;
    }

    #rebateModal .carousel-item img {
      max-width: 200px;
      display: block;
      margin: 0 auto;
    }

    #rebateModal .carousel-item p {
      margin: 10px 0 0;
      text-align: center;
    }

    #rebateModal .carousel-item .cashback-notice {
      color: #2a2a2a;
      font-size: 14px;
      background-color: #e6f3ff;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
      display: block;
      text-decoration: none;
    }

    #rebateModal .carousel-item .cashback-notice:hover {
      background-color: #d0e8ff;
      text-decoration: none;
    }

    #rebateModal .slick-track {
      opacity: 1 !important;
    }

    #rebateModal .slick-prev,
    #rebateModal .slick-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 48px;
      color: #333;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 1;
      padding: 10px;
      line-height: 1;
      opacity: 0.5;
    }

    #rebateModal .slick-prev:hover,
    #rebateModal .slick-next:hover {
      color: #000;
      opacity: 0.5;
    }

    #rebateModal .slick-prev {
      left: -24px;
    }

    #rebateModal .slick-next {
      right: -24px;
    }

    @media (max-width: 767px) {
      #rebateModal .carousel-item img {
        max-width: 150px;
        display: block;
        margin: 0 auto;
      }
    }
  </style>

  <!-- Inline JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('rebateModal');
      var closeBtn = modal.querySelector('.close');

      // Check session storage for modal display count
      var modalDisplayCount = sessionStorage.getItem('rebateModalCount') || 0;
      modalDisplayCount = parseInt(modalDisplayCount, 10);

      // Only show modal if displayed less than 3 times
      if (modalDisplayCount < 3) {
        modal.style.display = 'block';
        // Increment and update count
        sessionStorage.setItem('rebateModalCount', modalDisplayCount + 1);
      }

      // Close on X
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      // Close if clicked outside modal-content
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Initialize slick carousel
      try {
        $('.rebate-carousel').slick({
          slidesToShow: 3,
          slidesToScroll: 1,
          autoplay: true,
          autoplaySpeed: 3000,
          prevArrow: '<button type="button" class="slick-prev"><</button>',
          nextArrow: '<button type="button" class="slick-next">></button>',
          responsive: [
            {
              breakpoint: 768,
              settings: {
                slidesToShow: 1
              }
            }
          ]
        });
      } catch (e) {
        console.error('Slick initialization failed:', e);
      }
    });

    function sendEmail(event) {
      event.preventDefault();
      var email = document.getElementById('userEmail').value;
      var pdfUrl = '{{ 'Superwinch-rebate-form.pdf' | file_url }}';
      var subject = 'Superwinch Rebate Form';
      var body = 'Download your rebate form here: ' + pdfUrl + '\n\nPrint and complete it to claim your cash back.';
      window.location.href = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    }
  </script>
{% endif %}