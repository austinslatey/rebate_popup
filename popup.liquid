{% capture current_date %}{{ 'now' | date: '%s' }}{% endcapture %}
{% capture start_date %}{{ '2025-09-10' | date: '%s' }}{% endcapture %}
{% capture end_date %}{{ '2025-11-15' | date: '%s' | plus: 86399 }}{% endcapture %}

{% if current_date >= start_date and current_date <= end_date %}
  <div id="rebateModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img
        class="header-logo-image"
        src="https://cdn11.bigcommerce.com/s-c3z4vlowih/images/stencil/250x38/superwinch-logo-white_1724284008__21336.original.png"
        srcset="https://cdn11.bigcommerce.com/s-c3z4vlowih/images/stencil/250x38/superwinch-logo-white_1724284008__21336.original.png"
        alt="Superwinch"
        title="Superwinch"
      >
      <h2 id="color-change">Cash Back Rebate!</h2>
      <p class="secondary">
        From September 15 to November 15, 2025, get up to $100 cash back on select Superwinch items.
      </p>

      <!-- Carousel of qualifying items -->
      <h3 id="color-change">Qualifying Items:</h3>
      <div class="rebate-carousel">
        {% for product in collections['superwinch-rebate-2025'].products %}
          <div class="carousel-item">
            <a href="{{ product.url }}">
              <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title | escape }}">
              <p>{{ product.title }}</p>
              {% if product.metafields.custom.cash_back_rebate_amount != blank %}
                <div class="cashback-notice" style="color: #2a2a2a; font-size: 14px; background-color: #e6f3ff; border-radius: 4px; padding: 8px 12px; margin: 10px 0; text-align: center; font-weight: 500;">
                  Cash Back: {{ product.metafields.custom.cash_back_rebate_amount | times: 100 | money }}
                </div>
              {% endif %}
            </a>
          </div>
        {% else %}
          <p>No qualifying items available.</p>
        {% endfor %}
      </div>

      <button class="btn" onclick="window.location.href='https://store.waldoch.com/collections/superwinch-rebate-2025'">View All Products</button>
      <!-- Rebate form options -->
      <div class="rebate-form-container">
        <h3 id="color-change">Get Your Rebate Form:</h3>
        <div class="button-group">
          <button class="btn" onclick="window.open('{{ 'Superwinch-rebate-form.pdf' | file_url }}', '_blank')">
            View PDF
          </button>
          <form id="emailRebateForm" onsubmit="sendEmail(event)" class="rebate-form">
            <input type="email" id="userEmail" placeholder="Enter your email" required>
            <button type="submit" class="btn">Email PDF to Me</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline CSS for modal and carousel -->
  <style>
    #rebateModal.modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
    }

    .header-logo-image {
      display: block;
      margin: 0 auto;
      max-height: 2.35714rem;
    }

    .secondary {
      color: rgb(255, 204, 102);
    }

    .btn {
      background-color: rgb(255, 204, 102);
      font-size: 24px;
      margin: 0;
    }

    #color-change {
      margin-top: 8px;
      margin-bottom: 0;
      color: #fff;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgb(7, 64, 151);
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow: visible;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .rebate-form-container {
      margin: 20px 0;
      text-align: center;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .rebate-form {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 0;
    }

    .rebate-form input {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .btn {
      background-color: rgb(255, 204, 102);
      font-size: 16px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background-color: rgb(230, 184, 92);
    }

    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .rebate-carousel {
      background-color: #fff;
      margin: 20px;
      position: relative;
    }

    .carousel-item {
      text-align: center;
      padding: 10px;
    }

    .carousel-item img {
      max-width: 200px;
    }

    .slick-track {
      opacity: 1 !important;
    }

    /* Style for the arrows */
    .slick-prev,
    .slick-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 48px;
      color: #333;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 1;
      padding: 10px;
      line-height: 1;
      opacity: 0.5;
    }

    .slick-prev:hover,
    .slick-next:hover {
      color: #000;
      opacity: 0.5;
    }

    .slick-prev {
      left: -24px;
    }

    .slick-next {
      right: -24px;
    }

    /* Style for cashback notice in carousel */
    .carousel-item .cashback-notice {
      color: #2a2a2a;
      font-size: 14px;
      background-color: #e6f3ff;
      border-radius: 4px;
      padding: 8px 12px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
    }
  </style>

  <!-- Inline JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var modal = document.getElementById('rebateModal');
      var closeBtn = modal.querySelector('.close');

      // open on load
      modal.style.display = 'block';

      // close on X
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      // close if clicked outside modal-content
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // init slick
      try {
        $('.rebate-carousel').slick({
          slidesToShow: 3,
          slidesToScroll: 1,
          autoplay: true,
          autoplaySpeed: 3000,
          prevArrow: '<button type="button" class="slick-prev"><</button>',
          nextArrow: '<button type="button" class="slick-next">></button>',
          responsive: [
            {
              breakpoint: 768,
              settings: {
                slidesToShow: 1
              }
            }
          ]
        });
      } catch (e) {
        console.error('Slick initialization failed:', e);
      }
    });

    function sendEmail(event) {
      event.preventDefault();
      var email = document.getElementById('userEmail').value;
      var pdfUrl = '{{ 'Superwinch-rebate-form.pdf' | file_url }}';
      var subject = 'Superwinch Rebate Form';
      var body = 'Download your rebate form here: ' + pdfUrl + '\n\nPrint and complete it to claim your cash back.';
      window.location.href = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    }
  </script>
{% endif %}